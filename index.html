<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BuzzPi ‚Äî Demo (v9 ‚Ä¢ Long FX)</title>
<meta name="theme-color" content="#0b0b0f" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<style>
  :root{--bg:#fff;--fg:#0e0e12;--muted:#68707a;--card:#f7f8fa;--gold:#f7c948;--gold2:#e8b12e;--accent:#7b5df9;--ring:0 6px 18px rgba(0,0,0,.12)}
  @media (prefers-color-scheme: dark){:root{--bg:#0b0b0f;--fg:#eef0f3;--muted:#98a0aa;--card:#111318;--ring:0 8px 24px rgba(0,0,0,.45)}}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{max-width:800px;margin:0 auto;padding-bottom:96px}
  header{position:sticky;top:0;z-index:30;background:var(--bg);padding:12px 16px;border-bottom:1px solid rgba(127,127,127,.15)}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .logo{display:flex;gap:10px;align-items:center;font-weight:800}
  .logo-badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));box-shadow:var(--ring)}
  .tabs{display:flex;gap:8px;overflow:auto;padding:10px 16px}
  .chip{flex:0 0 auto;padding:8px 12px;border-radius:999px;background:var(--card);font-weight:600;color:var(--muted)}
  .chip.active{background:linear-gradient(135deg,#5b35f6,#7b5df9);color:#fff}
  .screen{display:none;padding:12px 16px}.screen.active{display:block}

  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--ring);margin-bottom:14px}
  .coins{font-size:28px;font-weight:800}
  .muted{color:var(--muted);font-size:13px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#5b35f6,#7b5df9);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;min-height:44px}
  .btn.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#212121}
  .btn.secondary{background:linear-gradient(135deg,#222,#333)}
  .btn.small{font-size:12px;padding:10px 12px}
  .rowBtns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .rowBtns.onecol{grid-template-columns:1fr}

  .small{font-size:12px}
  .bar{height:10px;background:#1f2330;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#5b35f6,#7b5df9)}

  .gsec{margin:18px 0}
  .gtitle{display:flex;align-items:center;gap:10px;margin:6px 0 10px}
  .gtitle span{font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:520px){.grid{grid-template-columns:repeat(3,1fr)}}
  .gift{background:var(--card);border-radius:14px;padding:10px;text-align:center;cursor:pointer;user-select:none;position:relative;box-shadow:var(--ring);transition:.2s}
  .gift .emo{font-size:26px;line-height:1}
  .gift .name{font-size:11px;color:var(--muted);margin-top:4px}
  .gift .price{font-size:12px;font-weight:800;margin-top:4px}
  .gift:active{transform:scale(.98)}
  .gift[data-tier="billionaire"]{outline:2px solid rgba(247,201,72,.25)}
  .gift[data-tier="rare"]{outline:2px solid rgba(91,53,246,.25)}

  /* selection heartbeat */
  .gift.highlight::after{content:"";position:absolute;inset:-2px;border-radius:16px;box-shadow:0 0 0 0 rgba(123,93,249,.5);animation:heartbeat 1200ms ease-in-out infinite}
  @keyframes heartbeat{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(123,93,249,.45)}25%{transform:scale(1.02);box-shadow:0 0 0 8px rgba(123,93,249,.15)}50%{transform:scale(1);box-shadow:0 0 0 0 rgba(123,93,249,0)}75%{transform:scale(1.02);box-shadow:0 0 0 8px rgba(123,93,249,.12)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(123,93,249,0)}}

  /* stage + combo */
  .stage{position:fixed;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;overflow:hidden;z-index:20}
  .combo{position:fixed;top:18%;left:50%;transform:translateX(-50%);font-weight:900;font-size:28px;background:linear-gradient(135deg,#5b35f6,#7b5df9);color:#fff;padding:6px 12px;border-radius:12px;box-shadow:var(--ring);opacity:0;animation:combo .3s ease forwards}
  @keyframes combo{to{opacity:1;transform:translateX(-50%) scale(1.05)}}

  /* simple DOM particles (fallbacks) */
  .pop{position:absolute;font-size:64px;animation:pop .6s ease-out forwards}
  @keyframes pop{0%{transform:scale(.5);opacity:.0}40%{transform:scale(1.1);opacity:1}100%{transform:scale(1) translateY(-120px);opacity:0}}
  .spark{position:absolute;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,#fff,#ffd);animation:spark 800ms ease-out forwards}
  @keyframes spark{from{transform:translate(0,0);opacity:1}to{transform:translate(var(--dx),var(--dy));opacity:0}}

  .nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid rgba(127,127,127,.15);display:flex;justify-content:space-around;align-items:center;padding:10px 8px 14px;z-index:30}
  .nav .item{display:flex;flex-direction:column;align-items:center;font-size:11px;color:var(--muted);text-decoration:none}
  .honeypot{position:relative;top:-22px;width:68px;height:68px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff8,transparent),linear-gradient(135deg,#fce38a,#f38181);box-shadow:0 10px 30px rgba(243,129,129,.35), inset 0 0 0 4px rgba(255,255,255,.35);display:flex;align-items:center;justify-content:center;border:0}
  .honeypot:after{content:"üçØ";font-size:28px}
  .honeypot:active{transform:scale(.97)}

  .toast{position:fixed;bottom:92px;left:50%;transform:translateX(-50%);background:#111c;border:1px solid #fff2;color:#fff;padding:10px 14px;border-radius:10px;backdrop-filter:blur(8px);font-size:13px;opacity:0;transition:.25s;z-index:40}
  .toast.show{opacity:1}

  .err{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:#ff3b30cc;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;z-index:50;display:none}
  .footerNote{opacity:.6;text-align:center;font-size:11px;margin:20px 0}

  /* Canvas layer always on top when active */
  #fx{position:fixed;inset:0;pointer-events:none;z-index:1000;display:none}
  #fxBadge{position:fixed;top:8px;left:8px;z-index:1001;background:#0009;color:#fff;border:1px solid #fff3;border-radius:8px;padding:4px 8px;font-size:11px;display:none}
</style>
</head>
<body>
<div class="err" id="err"></div>

<div class="app">
  <header>
    <div class="row">
      <div class="logo"><div class="logo-badge"></div> BuzzPi</div>
      <div class="coins" id="balance" title="Triple-tap: +100 ‚Ä¢ Long-press: +500">0</div>
    </div>
    <div class="tabs" id="topTabs">
      <div class="chip active">Following</div><div class="chip">Popular</div>
      <div class="chip">Nearby</div><div class="chip">Newcomers</div><div class="chip">Trending</div>
    </div>
  </header>

  <section class="screen active" id="scrHome">
    <div class="card"><div class="row">
      <div>
        <div style="font-weight:800">Welcome to BuzzPi (Demo)</div>
        <div class="muted">Tap the Gifts tab to try <b>alive</b> animations & coin flow.</div>
      </div>
      <div class="muted small">Theme-adaptive ‚úì</div>
    </div></div>
  </section>

  <section class="screen" id="scrGifts">
    <div class="card">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div class="muted small">Testing helpers:</div>
        <button class="btn small" id="btnPreviewBillion">Preview Billionaire FX</button>
        <button class="btn secondary small" id="btnGrant20k">Grant +20,000 (dev)</button>
      </div>
      <div class="muted small" style="margin-top:6px">Preview doesn‚Äôt charge coins ‚Ä¢ Grant lets you send 1k/5k/10k gifts.</div>
    </div>

    <div class="gsec"><div class="gtitle"><span>Common</span><small class="muted">1‚Äì20 BuzzCoins</small></div><div class="grid" id="gridCommon"></div></div>
    <div class="gsec"><div class="gtitle"><span>Rare</span><small class="muted">50‚Äì500 BuzzCoins</small></div><div class="grid" id="gridRare"></div></div>
    <div class="gsec"><div class="gtitle"><span>Billionaire</span><small class="muted">1,000‚Äì10,000 BuzzCoins</small></div><div class="grid" id="gridBillion"></div></div>
  </section>

  <section class="screen" id="scrWallet">
    <div class="card">
      <div class="coins"><span id="cRegular">0</span> <span class="muted">BuzzCoins</span></div>
      <div class="muted">Ad-earned balance: <b id="cAd">0</b> (gifting only)</div>
      <div class="muted small" id="adInfo"></div>
      <div class="rowBtns" style="margin-top:12px">
        <button class="btn gold" id="btnTopup">Top up +100</button>
        <button class="btn" id="btnWatchAd">Watch Ad (+1)</button>
      </div>
      <div class="rowBtns onecol" style="margin-top:8px">
        <button class="btn secondary small" id="btnReset">Reset demo</button>
      </div>
      <div class="muted small" style="margin-top:8px">Ad limit: 5/day ‚Ä¢ 5s cooldown ‚Ä¢ Tip: triple-tap balance for +100, long-press for +500</div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:800">Level <span id="level">1</span></div>
          <div class="muted">Spend 500 coins on gifts to level up</div>
        </div>
        <div class="muted small">Progress: <b id="lvPct">0%</b></div>
      </div>
      <div class="bar" style="margin-top:12px"><i id="lvBar"></i></div>
      <div class="muted small" id="lvHint" style="margin-top:8px"></div>
    </div>
  </section>

  <section class="screen" id="scrProfile">
    <div class="card"><div style="display:flex;gap:12px;align-items:center">
      <div class="logo-badge" style="width:44px;height:44px;border-radius:12px"></div>
      <div><div style="font-weight:800">You (Demo)</div><div class="muted small">Ranked badge & frames appear here later.</div></div>
    </div></div>
    <div class="card"><div style="font-weight:800;margin-bottom:8px">Stealth Mode (Phase 2)</div>
      <div class="muted small">Face mask + voice modulation will be here in Phase 2.</div>
    </div>
  </section>

  <div class="footerNote">If anything looks cached, reload with <code>?v=9</code>.</div>
</div>

<!-- DOM stage + Canvas FX -->
<div class="stage" id="stage"></div>
<canvas id="fx"></canvas>
<div id="fxBadge">FX RUNNING</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Helpers & Errors ===== */
function $(s){return document.querySelector(s)}
function el(t,c){const d=document.createElement(t); if(c) d.className=c; return d}
function showToast(m,ms=1600){const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms)}
function showErr(m){const e=$('#err'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',4000)}
window.onerror=(m,src,l,c,e)=>showErr('JS error: '+(e?.message||m));
window.onunhandledrejection=(ev)=>showErr('Promise error: '+(ev?.reason?.message||ev?.reason||'unknown'));

/* ===== State ===== */
const S={regular:300,ad:0,spent:0,adsToday:0,lastAdDate:null,holdTimer:null};
function save(){localStorage.setItem('buzz_demo_v9',JSON.stringify(S))}
function load(){try{Object.assign(S,JSON.parse(localStorage.getItem('buzz_demo_v9')||'{}'))}catch(_){}}

/* ===== UI refs ===== */
const EL={
  screens:{home:$('#scrHome'),gifts:$('#scrGifts'),wallet:$('#scrWallet'),profile:$('#scrProfile')},
  balance:$('#balance'), cRegular:$('#cRegular'), cAd:$('#cAd'),
  adInfo:$('#adInfo'), level:$('#level'), lvBar:$('#lvBar'), lvPct:$('#lvPct'), lvHint:$('#lvHint'),
  gridCommon:$('#gridCommon'),gridRare:$('#gridRare'),gridBillion:$('#gridBillion'),
  stage:$('#stage'), fx:$('#fx'), fxBadge:$('#fxBadge'),
  btnTopup:$('#btnTopup'), btnWatchAd:$('#btnWatchAd'), btnReset:$('#btnReset'),
  btnPreviewBillion:$('#btnPreviewBillion'), btnGrant20k:$('#btnGrant20k')
};
function fmt(n){return n.toLocaleString()}
function updateUI(){
  $('#balance').textContent=fmt(S.regular+S.ad);
  $('#cRegular').textContent=fmt(S.regular);
  $('#cAd').textContent=fmt(S.ad);
  const today=new Date().toISOString().slice(0,10);
  if(S.lastAdDate!==today){S.adsToday=0;S.lastAdDate=today;save()}
  $('#adInfo').textContent=`Ads watched today: ${S.adsToday}/5`;
  const per=500, lvl=Math.min(99,Math.floor(S.spent/per)+1), into=S.spent%per, pct=Math.round(into/per*100);
  $('#level').textContent=lvl; $('#lvPct').textContent=pct+'%'; $('#lvBar').style.width=pct+'%';
  $('#lvHint').textContent=`${fmt(per-into)} coins to Level ${Math.min(99,lvl+1)}`;
}
function spend(amount){
  if(amount>S.regular+S.ad) return false;
  const useAd=Math.min(S.ad,amount); S.ad-=useAd; S.regular-=(amount-useAd); S.spent+=amount; save(); updateUI(); return true;
}

/* ===== Gifts ===== */
const gifts={
  common:[
    {emoji:'ü•≥',name:'Party',price:1,anim:'party'},{emoji:'ü•∞',name:'Hearts',price:1,anim:'sparkle'},
    {emoji:'üòç',name:'Love Eyes',price:1,anim:'sparkle'},{emoji:'üòã',name:'Yum',price:1,anim:'lick'},
    {emoji:'ü§ó',name:'Hug',price:1,anim:'sparkle'},{emoji:'ü§©',name:'Starry',price:1,anim:'sparkle'},
    {emoji:'ü§ë',name:'Cashy',price:1,anim:'coins'},{emoji:'üç≠',name:'Lollipop',price:2,anim:'sparkle'},
    {emoji:'üç¨',name:'Candy',price:2,anim:'sparkle'},{emoji:'üç´',name:'Chocolate',price:2,anim:'sparkle'},
    {emoji:'üç∏',name:'Cocktail',price:5,anim:'sparkle'},{emoji:'üçé',name:'Apple',price:5,anim:'sparkle'},
    {emoji:'üç∫',name:'Beer',price:5,anim:'sparkle'},{emoji:'üåπ',name:'Rose',price:10,anim:'rose'},
    {emoji:'üå∏',name:'Blossom',price:10,anim:'rose'},{emoji:'‚ú®',name:'Sparkle',price:10,anim:'sparkle'},
    {emoji:'üíê',name:'Bouquet',price:20,anim:'rose'},{emoji:'üçª',name:'Cheers',price:20,anim:'clink'},
    {emoji:'üëè',name:'Clap',price:20,anim:'clap'},{emoji:'üíã',name:'Kiss',price:20,anim:'kiss'}
  ],
  rare:[
    {emoji:'ü¶ã',name:'Butterfly',price:50,anim:'butterfly'},{emoji:'üå©',name:'Storm',price:50,anim:'storm'},
    {emoji:'üå§',name:'Sunrise',price:50,anim:'sun'},{emoji:'üåà',name:'Rainbow',price:50,anim:'rainbow'},
    {emoji:'‚ùÑÔ∏è',name:'Snow',price:50,anim:'snow'},{emoji:'üß∏',name:'Teddy',price:100,anim:'sparkle'},
    {emoji:'üêá',name:'Bunny',price:100,anim:'sparkle'},{emoji:'üçæ',name:'Champagne',price:100,anim:'champagne'},
    {emoji:'üëë',name:'Crown',price:100,anim:'crown'},{emoji:'üç∑',name:'Wine',price:100,anim:'sparkle'},
    {emoji:'ü•Ç',name:'Toast',price:100,anim:'clink'},{emoji:'üèéÔ∏è',name:'Jade Lamborghini',price:500,anim:'car'},
    {emoji:'‚úàÔ∏è',name:'Crystal Aeroplane',price:500,anim:'planeSimple'},{emoji:'üöô',name:'Golden Hummer',price:500,anim:'car'},
    {emoji:'üõ•Ô∏è',name:'Yacht',price:500,anim:'yacht'}
  ],
  billionaire:[
    {emoji:'üî•üïäÔ∏è',name:'Fiery Phoenix',price:1000,anim:'phoenixFX'},
    {emoji:'ü¶Ñ',name:'Racing Unicorn',price:1000,anim:'unicornFX'},
    {emoji:'üè∞',name:'Crystal Castle',price:1000,anim:'castleFX'},
    {emoji:'üí∞',name:'Treasure Chest',price:1000,anim:'chestFX'},
    {emoji:'üèØ‚òÅÔ∏è',name:'Mansion in the Sky',price:5000,anim:'castleFX'},
    {emoji:'üßú‚Äç‚ôÄÔ∏è',name:'Mermaid',price:5000,anim:'sparkle'},
    {emoji:'üíò',name:'Cupids',price:5000,anim:'sparkle'},
    {emoji:'üßù‚Äç‚ôÄÔ∏è',name:'Elf Queen',price:5000,anim:'sparkle'},
    {emoji:'üõ©Ô∏è‚ú®',name:'Golden Private Jet',price:10000,anim:'jetFX'},
    {emoji:'üíé‚åö',name:'Diamond Rolex',price:10000,anim:'rolexFX'},
    {emoji:'üêéüöó',name:'Chariots of Horses',price:10000,anim:'unicornFX'}
  ]
};

/* ===== Render ===== */
function giftEl(g){const e=el('div','gift'); e.dataset.price=g.price; e.dataset.anim=g.anim||''; e.dataset.name=g.name; e.innerHTML=`<div class="emo">${g.emoji}</div><div class="name">${g.name}</div><div class="price">${fmt(g.price)}ü™ô</div>`; return e}
function mountGifts(){
  gifts.common.forEach(g=>EL.gridCommon.appendChild(giftEl(g)));
  gifts.rare.forEach(g=>{const e=giftEl(g); e.dataset.tier='rare'; EL.gridRare.appendChild(e)});
  gifts.billionaire.forEach(g=>{const e=giftEl(g); e.dataset.tier='billionaire'; EL.gridBillion.appendChild(e)});
}

/* ===== DOM fallback particles ===== */
function center(){return {x:innerWidth/2,y:innerHeight/2}}
function add(node,ms=1000){EL.stage.appendChild(node); setTimeout(()=>node.remove(),ms)}
function fallback(emoji){const p=el('div','pop');const {x,y}=center();p.textContent=emoji||'‚ú®';p.style.left=(x-28)+'px';p.style.top=(y-28)+'px';EL.stage.appendChild(p);for(let i=0;i<12;i++){const s=el('div','spark');s.style.left=x+'px';s.style.top=y+'px';s.style.setProperty('--dx',((Math.random()*2-1)*140|0)+'px');s.style.setProperty('--dy',(-60-Math.random()*120|0)+'px');EL.stage.appendChild(s);setTimeout(()=>s.remove(),800)}setTimeout(()=>p.remove(),620)}

/* ===== Canvas FX (robust) ===== */
let ctx=null, W=0, H=0, DPR=1;
function resizeFX(){
  if(!EL.fx) return;
  DPR=Math.min(2, (window.devicePixelRatio||1));
  W=innerWidth; H=innerHeight;
  EL.fx.width=W*DPR; EL.fx.height=H*DPR;
  if(ctx){ ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR); }
}
function startFX(){
  EL.fx.style.display='block'; EL.fxBadge.style.display='block';
  if(!ctx){ ctx=EL.fx.getContext('2d'); }
  if(!ctx){ EL.fx.style.display='none'; EL.fxBadge.style.display='none'; return false; }
  resizeFX();
  ctx.clearRect(0,0,W,H);
  // tiny dot to confirm canvas is painting
  ctx.fillStyle='rgba(255,255,255,.5)'; ctx.beginPath(); ctx.arc(14,14,4,0,Math.PI*2); ctx.fill();
  return true;
}
function endFX(){ if(!ctx) return; ctx.clearRect(0,0,W,H); EL.fx.style.display='none'; EL.fxBadge.style.display='none'; }
window.addEventListener('resize', resizeFX);
window.addEventListener('orientationchange', ()=>setTimeout(resizeFX, 150));

/* Utilities */
const R=()=>Math.random(), TAU=Math.PI*2;
function lerp(a,b,t){return a+(b-a)*t}
function easeOutCubic(t){return 1-Math.pow(1-t,3)}
function easeInOut(t){return t<.5? 4*t*t*t : 1-Math.pow(-2*t+2,3)/2}
function glow(ctx,x,y,r,a0=0.9,col='255,200,120'){
  const g=ctx.createRadialGradient(x,y,0,x,y,r);
  g.addColorStop(0,`rgba(${col},${a0})`);
  g.addColorStop(1,`rgba(${col},0)`);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill();
}

/* ===== Long-form Billionaire FX ===== */
/* Phoenix ‚Äî 6.0s */
function phoenixFX(){
  if(!startFX()){ fallback('üî•'); return }
  const t0=performance.now(), D=6000;
  (function loop(now){
    const t=Math.min(1,(now-t0)/D), p=easeInOut(t);
    ctx.clearRect(0,0,W,H);
    const x=lerp(-W*.2, W*1.1, p), y=lerp(H*.7, H*.25, p);
    // sustained glow trail (reduced particles per frame for perf)
    for(let i=0;i<70;i++){
      glow(ctx, x-R()*160, y+(R()*60-30), R()*26+12, (1-t)*(R()*0.4+0.35), '255,120,40');
    }
    glow(ctx,x,y,52,0.95,'255,160,60');
    ctx.fillStyle='rgba(255,240,200,.9)'; ctx.beginPath(); ctx.arc(x+6,y-6,4,0,TAU); ctx.fill();
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* Unicorn ‚Äî 5.5s */
function unicornFX(){
  if(!startFX()){ fallback('ü¶Ñ'); return }
  const t0=performance.now(), D=5500;
  ctx.font='64px system-ui, Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji';
  (function loop(now){
    const t=Math.min(1,(now-t0)/D), p=easeInOut(t);
    ctx.clearRect(0,0,W,H);
    const x=lerp(-100,W+100,p), y=lerp(H*.65,H*.35,p);
    const g=ctx.createLinearGradient(x-260,y-60,x,y+60);
    ['red','orange','yellow','lime','deepskyblue','indigo','violet'].forEach((c,i)=>g.addColorStop(i/6,c));
    ctx.globalAlpha=.9*(1-t); ctx.fillStyle=g; ctx.fillRect(x-260,y-28,240,56); ctx.globalAlpha=1;
    ctx.globalCompositeOperation='lighter';
    for(let i=0;i<54;i++){ const sx=x-R()*220, sy=y+(R()*60-30); ctx.fillStyle='rgba(255,255,255,.95)'; ctx.beginPath(); ctx.arc(sx,sy,R()*2+1.2,0,TAU); ctx.fill();}
    ctx.globalCompositeOperation='source-over';
    ctx.fillText('ü¶Ñ', x-24, y+18);
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* Jet ‚Äî 6.0s */
function jetFX(){
  if(!startFX()){ fallback('‚úàÔ∏è'); return }
  const t0=performance.now(), D=6000;
  ctx.font='60px system-ui, Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji';
  (function loop(now){
    const t=Math.min(1,(now-t0)/D), p=easeInOut(t);
    ctx.clearRect(0,0,W,H);
    const x=lerp(-180,W+180,p), y=lerp(H*.55,H*.35,p);
    ctx.globalCompositeOperation='lighter';
    ctx.fillStyle='rgba(255,255,255,.7)'; ctx.fillRect(x-260,y-6,240,12);
    if(t>.25 && t<.65){
      const k=(t-.25)/.4, r=lerp(22,180,k);
      ctx.strokeStyle=`rgba(255,255,255,${1-k})`; ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(x-60,y,r,0,TAU); ctx.stroke();
    }
    ctx.globalCompositeOperation='source-over';
    ctx.fillText('üõ©Ô∏è', x-20, y+18);
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* Castle ‚Äî 6.0s */
function castleFX(){
  if(!startFX()){ fallback('üè∞'); return }
  const t0=performance.now(), D=6000;
  ctx.font='70px system-ui, Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji';
  (function loop(now){
    const t=Math.min(1,(now-t0)/D), p=easeOutCubic(t), x=W/2, y=lerp(H*.82,H*.45,p);
    ctx.clearRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';
    for(let i=0;i<5;i++) glow(ctx,x,y+14,150+i*26,0.12*(1-t),'180,220,255');
    for(let i=0;i<70;i++){
      const ang=R()*TAU, rr=R()*160; const px=x+Math.cos(ang)*rr, py=y+Math.sin(ang)*rr;
      glow(ctx,px,py,3,0.9,'255,255,255');
    }
    ctx.globalCompositeOperation='source-over';
    ctx.textAlign='center'; ctx.fillText('üè∞', x, y);
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* Chest ‚Äî 5.5s */
function chestFX(){
  if(!startFX()){ fallback('üí∞'); return }
  const t0=performance.now(), D=5500;
  const coins=Array.from({length:120},()=>({x:W/2+(R()*180-90),y:H*.62,vx:(R()*2-1)*2.2,vy:-(R()*4+3.5),r:R()*3+2.2,a:1}));
  (function loop(now){
    const t=Math.min(1,(now-t0)/D);
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#6d4c41'; ctx.fillRect(W/2-80,H*.62,160,60);
    ctx.fillStyle='#8d6e63'; ctx.fillRect(W/2-80,H*.62-26,160,26);
    ctx.globalCompositeOperation='lighter';
    for(const c of coins){
      c.x+=c.vx; c.y+=c.vy; c.vy+=.12; c.a*=.993;
      const g=ctx.createRadialGradient(c.x,c.y,0,c.x,c.y,c.r*2.4);
      g.addColorStop(0,`rgba(255,240,180,${c.a})`);
      g.addColorStop(1,`rgba(255,215,80,0)`);
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,TAU); ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* Rolex ‚Äî 5.0s */
function rolexFX(){
  if(!startFX()){ fallback('üíé'); return }
  const t0=performance.now(), D=5000, x=W/2, y=H/2, R0=28, R1=160;
  (function loop(now){
    const t=Math.min(1,(now-t0)/D);
    ctx.clearRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';
    for(let i=0;i<40;i++){
      const ang=i*(TAU/40) + now*0.006, r=lerp(R0,R1,t), px=x+Math.cos(ang)*r, py=y+Math.sin(ang)*r;
      ctx.fillStyle=`hsla(${(i*12)%360},100%,70%,${1-t})`; ctx.beginPath(); ctx.arc(px,py,3,0,TAU); ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
    glow(ctx,x,y,12,1,'255,255,255');
    if(t<1) requestAnimationFrame(loop); else endFX();
  })(t0);
}

/* ===== Dispatch ===== */
const dispatch={
  // billionaire (now 5‚Äì6s each)
  phoenixFX, unicornFX, castleFX, chestFX, jetFX, rolexFX,
  // simple fallbacks for non-billionaire
  party:()=>fallback('ü•≥'), lick:()=>fallback('üòã'), butterfly:()=>fallback('ü¶ã'),
  car:()=>fallback('üèéÔ∏è'), rose:()=>fallback('üåπ'), champagne:()=>fallback('üçæ'),
  clink:()=>fallback('ü•Ç'), clap:()=>fallback('üëè'), kiss:()=>fallback('üíã'),
  coins:()=>fallback('ü™ô'), storm:()=>fallback('üå©'), rainbow:()=>fallback('üåà'),
  snow:()=>fallback('‚ùÑÔ∏è'), sun:()=>fallback('üå§'), crown:()=>fallback('üëë'),
  planeSimple:()=>fallback('‚úàÔ∏è'), yacht:()=>fallback('üõ•Ô∏è'), sparkle:()=>fallback('‚ú®')
};
function runAnim(key, emoji){ (dispatch[key]||(()=>fallback(emoji)))() }

/* Interactions */
function show(id){Object.values(EL.screens).forEach(s=>s.classList.remove('active')); EL.screens[id].classList.add('active')}
function mountNav(){
  const nav=el('nav','nav'); nav.innerHTML=`<a class="item" data-go="home"><div>üè†</div><div>Home</div></a>
  <a class="item" data-go="gifts"><div>üéÅ</div><div>Gifts</div></a>
  <button class="honeypot" title="Go Live"></button>
  <a class="item" data-go="wallet"><div>üí∞</div><div>Wallet</div></a>
  <a class="item" data-go="profile"><div>üë§</div><div>Profile</div></a>`;
  document.body.appendChild(nav);
  nav.addEventListener('click',e=>{const a=e.target.closest('[data-go]'); if(!a) return; show(a.getAttribute('data-go'))});
  nav.querySelector('.honeypot').addEventListener('click',()=>showToast('Go Live (demo) ‚Äî honeypot button!'));
}
function showCombo(n){const c=el('div','combo'); c.textContent='Combo x'+n; document.body.appendChild(c); setTimeout(()=>c.remove(),600)}
function sendOne(giftEl){
  const price=+giftEl.dataset.price; const emoji=giftEl.querySelector('.emo').textContent; const anim=giftEl.dataset.anim||'';
  if(!spend(price)){showToast('Not enough BuzzCoins ‚Äî open Wallet to top up'); return false}
  runAnim(anim, emoji); return true;
}
function bindGifting(){
  let combo=0, hold=null, pressing=false, highlighted=null;
  function select(el){ if(highlighted) highlighted.classList.remove('highlight'); highlighted=el; el.classList.add('highlight'); setTimeout(()=>{ if(highlighted===el) el.classList.remove('highlight')},1600)}
  function startHold(el){ pressing=true; combo=0; if(sendOne(el)){ combo=1; showCombo(combo)} hold=setInterval(()=>{ if(sendOne(el)){ combo++; if(combo%2===0) showCombo(combo)} else stopHold()},180)}
  function stopHold(){ pressing=false; clearInterval(hold); hold=null }
  document.addEventListener('pointerdown',e=>{const el=e.target.closest('.gift'); if(!el) return; select(el); S.holdTimer=setTimeout(()=>startHold(el),180)})
  document.addEventListener('pointerup',e=>{clearTimeout(S.holdTimer); const el=e.target.closest('.gift'); if(!el) return; if(!pressing) sendOne(el); stopHold()})
  document.addEventListener('pointerleave',()=>{clearTimeout(S.holdTimer); stopHold()})
}

/* Wallet + helpers */
function bindWallet(){
  EL.btnTopup.addEventListener('click',()=>{S.regular+=100; save(); updateUI(); showToast('+100 BuzzCoins')});
  EL.btnReset.addEventListener('click',()=>{localStorage.removeItem('buzz_demo_v9'); S.regular=300; S.ad=0; S.spent=0; S.adsToday=0; S.lastAdDate=null; save(); updateUI(); showToast('Demo reset')});
  let cool=false;
  EL.btnWatchAd.addEventListener('click',()=>{
    const today=new Date().toISOString().slice(0,10);
    if(S.lastAdDate!==today){S.adsToday=0;S.lastAdDate=today}
    if(S.adsToday>=5) return showToast('Daily ad limit reached');
    if(cool) return showToast('Please wait 5s‚Ä¶');
    S.ad+=1; S.adsToday+=1; save(); updateUI(); showToast('+1 from Ad');
    cool=true; EL.btnWatchAd.disabled=true; setTimeout(()=>{cool=false; EL.btnWatchAd.disabled=false},5000);
  });
  // balance gestures
  let taps=0, tapTimer=null, pressTimer=null;
  EL.balance.addEventListener('pointerdown',()=>{ pressTimer=setTimeout(()=>{ S.regular+=500; save(); updateUI(); showToast('+500 (long-press)') }, 600); });
  EL.balance.addEventListener('pointerup',()=>{
    clearTimeout(pressTimer); taps++; clearTimeout(tapTimer);
    tapTimer=setTimeout(()=>{ if(taps>=3){ S.regular+=100; save(); updateUI(); showToast('+100 (triple-tap)') } taps=0; }, 320);
  });
}

/* Preview + Grant */
function bindTestHelpers(){
  EL.btnPreviewBillion.addEventListener('click',()=>{
    const seq=['phoenixFX','unicornFX','castleFX','chestFX','jetFX','rolexFX'];
    // 6.5s spacing so each 5‚Äì6s effect finishes before the next begins
    seq.forEach((k,i)=>setTimeout(()=>runAnim(k,''), i*6500));
    showToast('Previewing Billionaire FX (long)');
  });
  EL.btnGrant20k.addEventListener('click',()=>{
    S.regular+=20000; save(); updateUI(); showToast('+20,000 BuzzCoins (dev)');
  });
}

/* Boot */
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    load(); updateUI(); mountGifts(); bindGifting(); bindWallet(); bindTestHelpers(); mountNav();
  }catch(e){ showErr('Init error: '+(e?.message||e)); }
});
</script>
</body>
</html>