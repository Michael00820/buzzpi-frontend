<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BuzzPi ‚Äì Pi SDK Sandbox (Diagnostics)</title>
  <style>
    :root{--pri:#7b5df9;--bg:#fafafa;--txt:#111}
    body{font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:24px}
    h1{margin:0 0 10px;font-size:28px;color:#5b35f6;text-align:center}
    p.lead{text-align:center;margin:0 0 24px;color:#444}
    .wrap{max-width:860px;margin:0 auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .card h3{margin:0 0 12px;font-size:18px}
    .full{grid-column:1/-1}
    button{appearance:none;border:0;border-radius:10px;background:var(--pri);color:#fff;font-weight:700;padding:12px 18px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;color:#666;margin-top:6px}
    .log{white-space:pre-wrap;background:#0e0e0e;color:#eaeaea;border-radius:10px;padding:14px;min-height:120px}
    code{background:#f1f1f1;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BuzzPi Pi SDK Sandbox ‚Äì Diagnostics</h1>
    <p class="lead">Open this page in the <b>Pi Browser</b> after enabling <b>Sandbox Mode</b> in the Pi app.</p>

    <div class="row">
      <div class="card">
        <h3>1) Initialize Pi SDK (sandbox)</h3>
        <button id="btnInit">Init SDK</button>
        <div class="hint">If nothing logs, re-enter Sandbox code: Pi App ‚Üí Menu ‚Üí Utilities ‚Üí Sandbox Mode.</div>
      </div>

      <div class="card">
        <h3>2) Sign in (username scope only)</h3>
        <button id="btnLogin" disabled>Sign In</button>
        <div class="hint">We‚Äôll re-enable <code>payments</code> after this works.</div>
      </div>

      <div class="card">
        <h3>Tools: SDK Check</h3>
        <button id="btnCheck">Run SDK Check</button>
        <div class="hint">Logs SDK methods so we know what‚Äôs available on your device.</div>
      </div>

      <div class="card">
        <h3>Tools: Test UI Popup</h3>
        <button id="btnPopup">Open Test Popup</button>
        <div class="hint">Calls <code>Pi.openShareDialog</code> (no permissions). If no popup, the UI channel is blocked.</div>
      </div>

      <div class="card full">
        <h3>Console</h3>
        <div id="log" class="log">Console ready‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Pi Browser SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const log = (...a)=>{ $('log').textContent += a.join(' ') + "\n"; console.log(...a); };

    const btnInit  = $('btnInit');
    const btnLogin = $('btnLogin');
    const btnCheck = $('btnCheck');
    const btnPopup = $('btnPopup');

    let sdkReady = false;

    // On load
    (function bootCheck(){
      const hasPi = typeof window.Pi !== 'undefined';
      log(`üîé window.Pi present: ${hasPi}`);
      if(!hasPi) log('‚ö†Ô∏è Load this URL inside Pi Browser. Normal browsers do not inject window.Pi.');
    })();

    btnInit.addEventListener('click', () => {
      if (!window.Pi) { log('‚ùå Pi SDK not found. Ensure Pi Browser + Sandbox Mode are active.'); return; }
      try {
        Pi.init({ version: "2.0", sandbox: true });
        sdkReady = true;
        btnLogin.disabled = false;
        log('‚úÖ Pi.init({ sandbox:true }) completed.');
      } catch (e) {
        log('‚ùå Pi.init error:', e?.message || e);
      }
    });

    btnLogin.addEventListener('click', async () => {
      log('üîµ Sign In clicked.');
      if (!window.Pi) { log('‚ùå Pi SDK not present.'); return; }
      if (!sdkReady) { log('‚ö†Ô∏è Please click "Init SDK" first.'); return; }

      try {
        // tiny delay helps some sandbox sessions
        await new Promise(r => setTimeout(r, 250));

        const scopes = ['username']; // username only
        log('‚è≥ Calling Pi.authenticate (username)‚Ä¶');

        let timeoutHit = false;
        const timer = setTimeout(()=>{
          timeoutHit = true;
          log('‚è± No auth sheet after 10s.');
          log('üëâ Fixes: (1) Re-enter Sandbox code in Pi App ‚Üí Utilities; (2) Force-close & reopen Pi Browser; (3) Pi Browser ‚Üí Settings ‚Üí Clear Cache; (4) Try "Test UI Popup".');
        }, 10000);

        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        if (!timeoutHit) clearTimeout(timer);

        log('‚úÖ Auth success ‚Üí user:', JSON.stringify(auth?.user));
      } catch (e) {
        log('‚ùå Auth error:', e?.message || e);
      }
    });

    btnCheck.addEventListener('click', () => {
      const has = typeof window.Pi !== 'undefined';
      log(`üß™ SDK present: ${has}`);
      if (!has) return;
      const keys = Object.keys(Pi||{}).sort();
      log('üîß SDK keys:', keys.join(', '));
      log('üîç typeof Pi.authenticate =', typeof Pi.authenticate);
      log('üîç typeof Pi.createPayment =', typeof Pi.createPayment);
      log('üîç typeof Pi.openShareDialog =', typeof Pi.openShareDialog);
    });

    btnPopup.addEventListener('click', async () => {
      if (!window.Pi) { log('‚ùå Pi SDK not present.'); return; }
      try {
        log('ü™ü Opening test popup‚Ä¶');
        await Pi.openShareDialog({ title: "BuzzPi", text: "UI test ‚Äì if you see a sheet, popups work." });
        log('‚úÖ Popup displayed (UI channel OK).');
      } catch (e) {
        log('‚ùå Popup error (UI channel blocked?):', e?.message || e);
        log('üëâ Try force-closing Pi Browser, re-arming Sandbox, or clearing Pi Browser cache.');
      }
    });

    function onIncompletePaymentFound(payment){
      log('‚ÑπÔ∏è Incomplete payment found:', JSON.stringify(payment));
    }
  </script>
</body>
</html>
