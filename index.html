<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BuzzPi ‚Äì Pi SDK Sandbox (Username Login)</title>
  <style>
    :root{--pri:#7b5df9;--bg:#fafafa;--txt:#111}
    body{font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:24px}
    h1{margin:0 0 10px;font-size:28px;color:#5b35f6;text-align:center}
    p.lead{text-align:center;margin:0 0 24px;color:#444}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    h3{margin:0 0 12px;font-size:18px}
    button{appearance:none;border:0;border-radius:10px;background:var(--pri);color:#fff;font-weight:700;padding:12px 18px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .log{white-space:pre-wrap;background:#0e0e0e;color:#eaeaea;border-radius:10px;padding:14px;min-height:72px}
    .hint{font-size:13px;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BuzzPi Pi SDK Sandbox Test</h1>
    <p class="lead">Open this page in the <b>Pi Browser</b> after enabling <b>Sandbox Mode</b> in the Pi app.</p>

    <div class="card">
      <h3>1) Initialize Pi SDK (sandbox)</h3>
      <button id="btnInit">Init SDK</button>
      <div class="hint">If nothing logs, re-enter Sandbox code: Pi App ‚Üí Menu ‚Üí Utilities ‚Üí Sandbox Mode.</div>
    </div>

    <div class="card">
      <h3>2) Sign in (username scope only)</h3>
      <button id="btnLogin" disabled>Sign In</button>
      <div class="hint">After this works, we‚Äôll re-enable the <code>payments</code> scope.</div>
    </div>

    <div class="card">
      <h3>Console</h3>
      <div id="log" class="log">Console ready‚Ä¶</div>
    </div>
  </div>

  <!-- Pi Browser SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const log = (...a)=>{ $('log').textContent += a.join(' ') + "\n"; console.log(...a); };

    const btnInit  = $('btnInit');
    const btnLogin = $('btnLogin');

    let sdkReady = false;

    // Quick check on load
    (function bootCheck(){
      const hasPi = typeof window.Pi !== 'undefined';
      log(`üîé window.Pi present: ${hasPi}`);
      if(!hasPi) log('‚ö†Ô∏è Load this URL inside Pi Browser. Normal browsers do not inject window.Pi.');
    })();

    btnInit.addEventListener('click', () => {
      if (!window.Pi) { log('‚ùå Pi SDK not found. Ensure Pi Browser + Sandbox Mode are active.'); return; }
      try {
        Pi.init({ version: "2.0", sandbox: true });
        sdkReady = true;
        btnLogin.disabled = false;
        log('‚úÖ Pi.init({ sandbox:true }) completed.');
      } catch (e) {
        log('‚ùå Pi.init error:', e?.message || e);
      }
    });

    btnLogin.addEventListener('click', async () => {
      log('üîµ Sign In clicked.');
      if (!window.Pi) { log('‚ùå Pi SDK not present.'); return; }
      if (!sdkReady) { log('‚ö†Ô∏è Please click "Init SDK" first.'); return; }
      try {
        // Small delay helps some sandbox sessions display the sheet
        await new Promise(r => setTimeout(r, 250));

        const scopes = ['username']; // ‚Üê username-only for reliability
        log('‚è≥ Calling Pi.authenticate (username)‚Ä¶');
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        log('‚úÖ Auth success ‚Üí user:', JSON.stringify(auth?.user));
        log('üéØ Great! Now we can re-add the "payments" scope next.');
      } catch (e) {
        log('‚ùå Auth error:', e?.message || e);
        setTimeout(()=>log('‚ÑπÔ∏è If no popup appeared, re-enter Sandbox code in Pi App ‚Üí Utilities, then reload.'), 1500);
      }
    });

    function onIncompletePaymentFound(payment){
      log('‚ÑπÔ∏è Incomplete payment found:', JSON.stringify(payment));
    }
  </script>
</body>
</html>
